# Detailed Flow Logic: MPR-02 HR Assignment

## 1. Introduction

This document provides a technical deep-dive into the Power Automate flow (`MPR-02HRAssignment`). Its purpose is to handle the assignment of an HR representative to an approved MPR, using an interactive Teams card and dynamic choice set.

---

## 2. Overall Flow Structure

The flow is triggered when an item in the `MPR Tracker` SharePoint list is modified and the `Status` field is set to `MPR Approved`. It then:
1. Retrieves the HR Manager and HR Team from the System Configuration list.
2. Builds a dynamic choice set for the HR Manager using the HR Team members.
3. Posts an adaptive card to the HR Manager in Teams and waits for a response.
4. Updates the SharePoint item with the selected HR Rep and changes the status to `CV Sourcing`.
5. Sends notifications via Teams and email to the assigned HR Rep, HR Manager, and requester.

---

## 3. Trigger & Condition

- **Trigger:** When an item is created or modified in the `MPR Tracker` SharePoint list.
- **Trigger Condition:** The flow only runs when the `Status` field changes to `MPR Approved`.
- **Connector:** SharePoint Online (`GetOnUpdatedItems`)

---

## 4. Data Gathering

- **Get HR Manager:**
  - **Connector:** SharePoint Online (`GetItems`)
  - **Action:** Retrieves the HR Manager from the System Configuration list where Title = 'HR Manager'.
  - **Configuration:** `$filter`: `Title eq 'HR Manager'`, `$top`: 1

- **Get HR Team:**
  - **Connector:** SharePoint Online (`GetItems`)
  - **Action:** Retrieves all HR Team members from the System Configuration list where Title = 'HR Team'.
  - **Configuration:** `$filter`: `Title eq 'HR Team'`

---

## 5. Adaptive Card Preparation

- **Select:**
  - **Connector:** Data Operation (`Select`)
  - **Action:** Builds a choice set from the HR Team members, mapping DisplayName and Email for the adaptive card.
  - **Input:** From `Get_HR_Team` results, select `{ title: DisplayName, value: Email }`

- **Compose Adaptive Card Payload:**
  - **Connector:** Data Operation (`Compose`)
  - **Action:** Creates the adaptive card JSON payload, including requisition details and the dynamic HR Team choice set.
  - **Configuration:** Uses the output of `Select` for the choices in the card.

---

## 6. Interactive Notification

- **For Each HR Manager:**
  - **Connector:** Teams (`PostCardAndWaitForResponse`)
  - **Action:** Posts the adaptive card to the HR Manager in Teams and waits for a response.
  - **Configuration:** Recipient is the HR Manager's email from System Configuration.

---

## 7. Response Handling & Finalization

- **Parse JSON:**
  - **Connector:** Data Operation (`ParseJson`)
  - **Action:** Parses the response from the adaptive card to extract the selected HR Rep's email.

- **Update Item:**
  - **Connector:** SharePoint Online (`PatchItem`)
  - **Action:** Updates the SharePoint item with the selected HR Rep (`AssignedTo`) and sets the status to `CV Sourcing`.
  - **Configuration:** Also updates the `LastUpdate` field with the current timestamp.

- **Post Message in Teams:**
  - **Connector:** Teams (`PostMessageToConversation`)
  - **Action:** Sends a Teams message to the assigned HR Rep, notifying them of the new assignment.

- **Send Email:**
  - **Connector:** Office 365 (`SendEmailV2`)
  - **Action:** Sends an email to the assigned HR Rep, CC'ing the HR Manager and requester, with requisition details and assignment notification.

---

## 8. Screenshots & Visuals

*(Insert screenshots of each major flow section here: trigger, data gathering, card preparation, notification, response handling, and update actions.)*

---

## 9. Maintenance Notes

- Ensure the System Configuration list is kept up to date for accurate HR Manager and HR Team assignment options.
- The trigger condition should be reviewed if the status lifecycle changes in future updates.
